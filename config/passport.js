var passport = require("passport");
var LocalStrategy = require("passport-local").Strategy;
var User = require("../models/User");

// authenticate() -> req.login() -> passport.serializeUser() -> Store to req.session
passport.serializeUser(function (user, done) {
  done(null, user.id);
});

// req.session -> DB
passport.deserializeUser(function (id, done) {
  User.findOne({ _id: id }, function (err, user) {
    done(err, user);
  });
});

passport.use(
  "local-login",
  new LocalStrategy(
    {
      usernameField: "username",
      passwordField: "password",
      passReqToCallback: true,
    },
    function (req, username, password, done) {
      User.findOne({ username: username })
        .select({ password: true })
        .exec(function (err, user) {
          if (err) return done(err);

          if (user && user.authenticate(password)) {
            return done(null, user);
          }
          req.flash("username", username);
          req.flash("errors", {
            login: "The username or password is incorrect.",
          });
          return done(null, false);
        });
    }
  )
);
module.exports = passport;
